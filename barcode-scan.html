<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>Sense barcode scanner</title>
</head>

<!-- Bootstrap 5.3.0 alpha 1 -->
<link rel="stylesheet" href="dist/bootstrap-5.3.0-alpha1-dist/css/bootstrap.css">

<body>
    <div id="reader" class="container-fluid"></div>
    <div class="">
        <span>Информация:</span>
        <div id="text"></div>
        <span>Тип barcode:</span>
        <div id="result"></div>
    </div>

    <div class="card h-100 m-3">
        <div class="card-body">
            <h5 class="card-title">Информация о датчике:</h5>
            <h6 class="card-subtitle mb-2 text-muted" id="Наименование"></h6>
            <hr class="border opacity-75">
            <span class="">Серия: </span>
            <span class="card-text" id="БИП"></span>
            <hr class="border opacity-75">
            <span class="">(Мд) Модель устройства: </span>
            <span class="card-text" id="МД"></span>
            <hr class="border opacity-75">
            <span class="">(АМ) Аппаратная модификация устройства: </span>
            <span class="card-text" id="АМ"></span>
            <hr class="border opacity-75">
            <span class="">Исполнение по подключению ПИП вибрации: </span>
            <span class="card-text" id="И1"></span>
            <hr class="border opacity-75">
            <span class="">(И2) Исполнение по подключению ПИП температуры: </span>
            <span class="card-text" id="И2"></span>
            <hr class="border opacity-75">
            <span class="">(И3) Исполнение по типу антенны: </span>
            <span class="card-text" id="И3"></span>
            <hr class="border opacity-75">
            <span class="">(И4) Исполнение по электропитанию: </span>
            <span class="card-text" id="И4"></span>
            <hr class="border opacity-75">
            <span class="">(СИ) Код специсполнения: </span>
            <span class="card-text" id="СИ"></span>
        </div>
    </div>
</body>

<!--  -->
<script>
    const getData = async url => {
        const response = await fetch(url);
        const data = await response.json();
        return data;
    }
</script>

<!-- Bootstrap 5.3.0 alpha 1 -->
<script src="dist/bootstrap-5.3.0-alpha1-dist/js/bootstrap.bundle.min.js"></script>

<!-- html5-qrcode 2.3.4 (stable) -->
<!-- <script src="js/html5-qrcode.min@2.3.4.js"></script> -->
<script src="js/html5-qrcode.min@2.3.4.js"></script>
<script>
    // Handle on success condition with the decoded text or result.
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('text').innerText = `${decodedText}`;
        document.getElementById('result').innerText = `${decodedResult.result.format.formatName}`;


        const strDash = decodedText.split('-');
        const strDot = strDash[1].split('.');

        if (strDash[0] == 'БИП') {
            if (strDot[0] == 'G') {
                jsonLink = 'https://raw.githubusercontent.com/deviashin/iiotsense.ru/main/db/bip-g.json';
            }
            else { }
        }

        getData(jsonLink)
            .then(data => {
                document.getElementById('Наименование').innerText = `${data.Наименование}`;
                document.getElementById('БИП').innerText = `${data.Серия}`;
                document.getElementById('МД').innerText = `${data.Модель.МД[strDot[0] + strDot[1]].Имя}`;
                document.getElementById('АМ').innerText = `${data.Модель.АМ}`;
                document.getElementById('И1').innerText = `${data.Модель.МД.G1.И1[strDot[3][0]]}`;
                document.getElementById('И2').innerText = `${data.Модель.МД.G1.И2[strDot[3][1]]}`;
                document.getElementById('И3').innerText = `${data.Модель.И3[strDot[3][2]]}`;
                document.getElementById('И4').innerText = `${data.Модель.И4[strDot[3][3]]}`;
                document.getElementById('СИ').innerText = `${data.Модель.СИ['0']}`;
            })


        // document.location.href = "https://api.telegram.org/bot2100711838:AAE2qHOz6R68rHJZB93Xf_CDOyrfCiqCI7Q/sendMessage?chat_id=-1001752025790&text=result:" + `${decodedText}`;
        // console.log(`Scan result: ${decodedText}`, decodedResult);
        // window.alert(decodedText);
    }

    // Handle on error condition, with error message
    function onScanError(errorMessage) { }

    // Square QR Box, with size = 70% of the min edge.
    let qrboxFunction = function (viewfinderWidth, viewfinderHeight) {
        let minEdgeSizeThreshold = 250;
        let edgeSizePercentage = 0.8;
        let minEdgeSize = (viewfinderWidth > viewfinderHeight) ? viewfinderHeight : viewfinderWidth;
        let qrboxEdgeSize = Math.floor(minEdgeSize * edgeSizePercentage);
        if (qrboxEdgeSize < minEdgeSizeThreshold) {
            if (minEdgeSize < minEdgeSizeThreshold) {
                return {
                    width: minEdgeSize,
                    height: minEdgeSize
                };
            } else {
                return {
                    width: minEdgeSizeThreshold,
                    height: minEdgeSizeThreshold
                };
            }
        }
        return { width: qrboxEdgeSize, height: qrboxEdgeSize };
    }

    let config = {
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
        },
        rememberLastUsedCamera: true,
        focusMode: "continuous",
        fps: 10,
        // qrbox: {
        //     width: 250,
        //     height: 250
        // },
        qrbox: qrboxFunction,
        showTorchButtonIfSupported: true,
        showZoomSliderIfSupported: true,
        defaultZoomValueIfSupported: 1,
        // supportedScanTypes: [
        //     Html5QrcodeScanType.SCAN_TYPE_CAMERA,
        //     Html5QrcodeScanType.SCAN_TYPE_FILE
        // ],
        // formatsToSupport: [
        //     Html5QrcodeSupportedFormats.QR_CODE,
        //     Html5QrcodeSupportedFormats.DATA_MATRIX
        // ],
    };

    let html5QrcodeScanner = new Html5QrcodeScanner("reader", config, /* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess, onScanError);

    // Костыли с переопределением CSS и Text для элементов интерфейса:
    let style33 = document.createElement('style');
    style33.innerHTML =
        `
        img {
            display:none;
        }
        `;
    document.head.appendChild(style33);


    // Привязка тега <a> для переключения выбора источника сканирования (камера или изображение):
    let anchorScanTypeChange = document.querySelector('#html5-qrcode-anchor-scan-type-change');
    let anchorScanTypeChangeFlag;
    anchorScanTypeChange.classList.remove("html5-qrcode-element");
    anchorScanTypeChange.classList.add("btn", "btn-success", "shadow", "mt-2", "text-decoration-none");
    anchorScanTypeChange.textContent = 'Сканировать из файла';

    // Идентификатор кнопки выбора файла:
    let btnFileSelection = document.querySelector('#html5-qrcode-button-file-selection');
    btnFileSelection.classList.remove("html5-qrcode-element");
    btnFileSelection.classList.add("btn", "btn-success", "shadow", "mt-2", "text-decoration-none");

    anchorScanTypeChange.addEventListener('click', function () {
        !anchorScanTypeChangeFlag ? anchorScanTypeChange.textContent = 'Сканировать камерой' : anchorScanTypeChange.textContent = 'Сканировать из файла';
        anchorScanTypeChangeFlag = !anchorScanTypeChangeFlag;
        btnFileSelection.textContent = 'Выбрать файл на устройстве';
    });



    // Дать разрешение на использование видеокамеры и начать захват видеопотока:
    let btnCameraPerm = document.querySelector('#html5-qrcode-button-camera-permission');
    btnCameraPerm.classList.remove("html5-qrcode-element");
    btnCameraPerm.classList.add("btn", "btn-success", "shadow");
    btnCameraPerm.textContent = 'Запустить сканирование';
    // btnCameraPerm.addEventListener('click', function () { });

    let btnCameraStart = document.querySelector('#html5-qrcode-button-camera-start');
    btnCameraStart.addEventListener('click', function () {
        btnCameraStop.classList.remove("html5-qrcode-element");
        btnCameraStop.classList.add("btn", "btn-success", "shadow");
        btnCameraStop.textContent = 'Стоп';
    });

    let btnCameraStop = document.querySelector('#html5-qrcode-button-camera-stop');
    btnCameraStop.addEventListener('click', function () {
        btnCameraStart.classList.remove("html5-qrcode-element");
        btnCameraStart.classList.add("btn", "btn-success", "shadow");
        btnCameraStart.textContent = 'Старт';
    });


    // let btnTorch = document.querySelector('#html5-qrcode-button-torch');
    // btnTorch.classList.remove("html5-qrcode-element");
    // btnTorch.classList.add("btn", "btn-success", "shadow");
    // btnTorch.textContent = 'Фонарик?';

    // let selectCamera = document.querySelector('#html5-qrcode-select-camera');
    // selectCamera.classList.remove("html5-qrcode-element");
    // selectCamera.classList.add("");
    // selectCamera.textContent = 'Выбрать камеру';



    // let NAME = document.getElementById('#html5-qrcode-input-range-zoom');
    // NAME.classList.remove("html5-qrcode-element");
    // NAME.classList.add("");
    // NAME.textContent = 'Масштабирование';



    // let readerHeaderMessage = document.getElementById('#reader__header_message');
    // if (readerHeaderMessage != null) {
    //     readerHeaderMessage.classList.remove("html5-qrcode-element");
    //     readerHeaderMessage.classList.add("");
    //     readerHeaderMessage.textContent = 'd';
    // }

    //
    // let btnTorchOn = document.getElementById('#html5-qrcode-button-torch-on');
    // if (btnTorchOn != null) {
    //     btnTorchOn.classList.remove("html5-qrcode-element");
    //     btnTorchOn.classList.add("");
    //     btnTorchOn.textContent = 'Включить фонарик';
    // }

    //
    // let btnTorchOff = document.querySelector('#html5-qrcode-button-torch-off');
    // if (btnTorchOff != null) {
    //     btnTorchOff.classList.remove("html5-qrcode-element");
    //     btnTorchOff.classList.add("");
    //     btnTorchOff.textContent = 'Выключить фонарик';
    // }
</script>

</html>
<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
    <title>Проверка продукции</title>

    <!-- Bootstrap 5.3.0 alpha 1 -->
    <link rel="stylesheet" href="css/bootstrap.css">

    <!-- Bootstrap Icons 1.10.3 -->
    <link rel="stylesheet" href="dist/bootstrap-icons-1.10.3/bootstrap-icons.css">

    <!-- Font Awesome Pro 6.1.0 web -->
    <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/fontawesome.min.css">
    <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/brands.css">
    <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/duotone.css">
    <!-- <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/light.css"> -->
    <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/regular.css">
    <!-- <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/solid.css"> -->
    <!-- <link rel="stylesheet" href="dist/fontawesome-pro-6.1.0-web/css/thin.css"> -->

    <!-- PF BeauSans Pro -->
    <!-- <link rel="stylesheet" href="css/fonts.css"> -->

    <!-- ITC-Slider 1.0.0 -->
    <link rel="stylesheet" href="css/itc-slider.css">

    <!-- IIoT Sense style -->
    <link rel="stylesheet" href="css/sense-styles-racoon-bs.css">
    <link rel="stylesheet" href="css/sense-style.css">
</head>

<body>
    <div class="container-fluid m-0 p-0 mb-4" id="reader"></div>
    <div class="" id="barcode-device-list"></div>

    <div class="container-fluid my-3 d-none" id="scan-info">
        <h3 class="d-flex justify-content-between align-items-center mb-3 ps-1">
            <span class="text-success fs-2">Информация о изделии:</span>
        </h3>
        <div class="card m-1 shadow-lg border-0">
            <div class="card-body p-3">
                <h5 class="card-subtitle mb-4 text-muted" id="Наименование"></h5>
                <span class="fw-bold">Серийный номер: </span>
                <span class="card-text" id="SN"></span>
                <hr class="border opacity-50">
                <span class="fw-bold">Производственная серия: </span>
                <span class="card-text" id="device-line"></span>
                <hr class="border opacity-50">
                <span class="fw-bold">Модель устройства: </span>
                <span class="card-text" id="МД"></span>
                <hr class="border opacity-50">
                <span class="fw-bold">Аппаратная модификация устройства: </span>
                <span class="card-text" id="АМ"></span>

                <div class="accordion pt-4" id="accordionExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                Дополнительная информация
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne"
                            data-bs-parent="#accordionExample">
                            <div class="accordion-body" id="collapseFirst">
                                <!-- <hr class="border opacity-50">
                                <span class="fw-bold">Исполнение по подключению ПИП вибрации: </span>
                                <span class="card-text" id="И1"></span>
                                <hr class="border opacity-50">
                                <span class="fw-bold">Исполнение по подключению ПИП температуры: </span>
                                <span class="card-text" id="И2"></span>
                                <hr class="border opacity-50">
                                <span class="fw-bold">Исполнение по типу антенны: </span>
                                <span class="card-text" id="И3"></span>
                                <hr class="border opacity-50">
                                <span class="fw-bold">Исполнение по электропитанию: </span>
                                <span class="card-text" id="И4"></span>
                                <hr class="border opacity-50">
                                <span class="fw-bold">Код специсполнения: </span>
                                <span class="card-text" id="СИ"></span> -->
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                                Служебная информация
                            </button>
                        </h2>
                        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo"
                            data-bs-parent="#accordionExample">
                            <div class="accordion-body">
                                <span>Информация:</span>
                                <div id="text"></div>
                                <span>Тип barcode:</span>
                                <div id="result"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="arrow-up-short" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5z" />
        </symbol>
    </svg>
    <div class="btn-up btn-up_hide shadow-lg">
        <svg class="btn-up-icon" role="img" aria-label="Прокрутить страницу к началу">
            <use xlink:href="#arrow-up-short"></use>
        </svg>
    </div>
    <a href="#" onclick="location.reload(); return false;" class="d-none" id="scan-info">
        <div class="btn-up btn-scan shadow-lg">
            <i class="fa-regular fa-qrcode fa-2xl"></i>
        </div>
    </a>
</body>

<!--  -->
<script>
    const getData = async url => {
        const response = await fetch(url);
        const data = await response.json();
        return data;
    }
</script>

<!--  -->
<script>
    function parseBarcodeOne(str) {
        // Создание и добавление элементов списка с параметрами изделия:
        function addElementsList(name, addr, hr = 1) {
            let spanName = document.createElement('span');
            spanName.className = "fw-bold";
            spanName.innerText = name;
            document.querySelector('#collapseFirst').append(spanName);

            let spanAddr = document.createElement('span');
            spanAddr.className = "card-text";
            spanAddr.innerText = addr;
            document.querySelector('#collapseFirst').append(spanAddr);

            if (hr) {
                let hr = document.createElement('hr');
                hr.className = "border opacity-50";
                document.querySelector('#collapseFirst').append(hr);
            }
        }

        // :
        let jsonLink = 'https://raw.githubusercontent.com/deviashin/iiotsense.ru/main/db/bip-all.json';
        str = str.slice(str.split('?')[0].length + 1);
        switch (str[0] + str[1]) {
            case 'CC':
                jsonLink = 'https://raw.githubusercontent.com/deviashin/iiotsense.ru/main/db/bip-tk.json';
                break;

            case 'D1':
                jsonLink = 'https://raw.githubusercontent.com/deviashin/iiotsense.ru/main/db/bip-g.json';
                break;

            default:
                break;
        }
        console.log('Получен документ: ' + jsonLink);

        // :
        getData(jsonLink)
            .then(data => {
                // Получаем настоящий серийный номер:
                let SerialN = str[0] + str[1];
                for (let i = 5; i < 10; i++) { SerialN += str[i]; }
                document.getElementById('SN').innerText = `${SerialN}`;

                // Получаем основную информацию об устройстве:
                document.getElementById('device-line').innerText = `${data.Серия}`;
                document.getElementById('АМ').innerText = `${data.Модель.АМ}`;

                // http://IIOTSENSE.RU/P?D10000034710111105871
                // D1 - 0, 1
                // 00000347 - 2, 3, 4, 5, 6, 7, 8, 9
                // 1 - 10
                // 01 - 11, 12
                // 1110 - 13, 14, 15, 16
                // 5871 - 17, 18, 19, 20

                // http://IIOTSENSE.RU/P?CC0000026901112204046
                // CC - 0, 1
                // 00000269 - 2, 3, 4, 5, 6, 7, 8, 9
                // 01 - 10, 11
                // 11220 - 12, 13, 14, 15, 16
                // 4046 - 17, 18, 19, 20

                // Получаем дополнительную информацию в зависимости от типа устройства:
                switch (str[0] + str[1]) {
                    case 'CC':
                        document.getElementById('МД').innerText = `${data.Модель.МД['К'].Имя}`;

                        // document.getElementById('И1').innerText = `${data.Модель.МД['К'].И1[str[12]]}`;
                        addElementsList('Исполнение по измерению: ', data.Модель.МД['К'].И1[str[12]]);

                        // document.getElementById('И2').innerText = `${data.Модель.МД['К'].И2[str[13]]}`;
                        addElementsList('Монтажная часть тип 1: ', data.Модель.МД['К'].И2['1' + str[13]]);

                        // document.getElementById('И2').innerText = `${data.Модель.МД['К'].И3[str[14]]}`;
                        addElementsList('Монтажная часть тип 2: ', data.Модель.МД['К'].И3['2' + str[14]]);

                        // document.getElementById('И4').innerText = `${data.Модель.И4[str[15]]}`;
                        addElementsList('Исполнение по типу антенны: ', data.Модель.И4[str[15]]);

                        // document.getElementById('И5').innerText = `${data.Модель.И5[str[16]]}`;                      
                        addElementsList('Исполнение по электропитанию: ', data.Модель.И5[str[16]], false);

                        // document.getElementById('СИ').innerText = `${data.Модель.СИ['0']}`;
                        break;

                    case 'D1':
                        // document.getElementById('МД').innerText = `${data.Модель.МД['G' + str[10]].Имя}`;
                        addElementsList('Исполнение по типу антенны: ', data.Модель.МД['G' + str[10]].Имя);

                        // document.getElementById('И1').innerText = `${data.Модель.МД['G' + str[10]].И1[str[13]]}`;
                        addElementsList('Исполнение по подключению ПИП вибрации: ', data.Модель.МД['G' + str[10]].И1[str[13]]);

                        // document.getElementById('И2').innerText = `${data.Модель.МД['G' + str[10]].И2[str[14]]}`;
                        addElementsList('Исполнение по подключению ПИП температуры: ', data.Модель.МД['G' + str[10]].И2[str[14]]);

                        // document.getElementById('И3').innerText = `${data.Модель.И3[str[15]]}`;
                        addElementsList('Исполнение по типу антенны: ', data.Модель.И3[str[15]]);

                        // document.getElementById('И4').innerText = `${data.Модель.И4[str[16]]}`;
                        addElementsList('Исполнение по электропитанию: ', data.Модель.И4[str[16]], false);

                        // document.getElementById('СИ').innerText = `${data.Модель.СИ['0']}`;
                        break;

                    default:
                        break;
                }
            });
    }

    // function parseBarcodeTwo(str) {
    //     const strDash = decodedText.split('-');
    //     const strDot = strDash[1].split('.');

    //     if (strDash[0] == 'device-line') {
    //         if (strDot[0] == 'G') {
    //             jsonLink = 'https://raw.githubusercontent.com/deviashin/iiotsense.ru/main/db/bip-g.json';
    //         }
    //         else { }
    //     }
    //     parseBarcodeOne('IIOTSENSE.RU/P?D10000034710111105871');
    //     getData(jsonLink)
    //         .then(data => {
    //             document.getElementById('Наименование').innerText = `${data.Наименование}`;
    //             document.getElementById('device-line').innerText = `${data.Серия}`;
    //             document.getElementById('МД').innerText = `${data.Модель.МД[strDot[0] + strDot[1]].Имя}`;
    //             document.getElementById('АМ').innerText = `${data.Модель.АМ}`;
    //             document.getElementById('И1').innerText = `${data.Модель.МД.G1.И1[strDot[3][0]]}`;
    //             document.getElementById('И2').innerText = `${data.Модель.МД.G1.И2[strDot[3][1]]}`;
    //             document.getElementById('И3').innerText = `${data.Модель.И3[strDot[3][2]]}`;
    //             document.getElementById('И4').innerText = `${data.Модель.И4[strDot[3][3]]}`;
    //             document.getElementById('СИ').innerText = `${data.Модель.СИ['0']}`;
    //         });
    // }

    function interfaceReload(str) {
        document.querySelectorAll('#scan-info').forEach((slider) => {
            slider.classList.remove("d-none");
            slider.classList.add("d-block");
            console.log(slider);
        });
    }


    interfaceReload();
    // parseBarcodeOne('IIOTSENSE.RU/P?CC0000026901112204046');
    parseBarcodeOne('IIOTSENSE.RU/P?D10000034710111105871');
</script>

<!-- Bootstrap 5.3.0 alpha 1 -->
<script src="js/bootstrap.js"></script>

<!-- html5-qrcode 2.3.4 (stable) -->
<!-- <script src="js/html5-qrcode.min@2.3.4.js"></script> -->
<!-- html5-qrcode 2.3.7 (stable) -->
<script src="js/html5-qrcode.min@2.3.7.js"></script>
<script>
    // Этот метод активирует разрешения пользователя:
    Html5Qrcode.getCameras().then(devices => {
        /** Устройства (камеры) будут массивом объектов типа:
         * { id: "id", label: "label" } */
        if (devices && devices.length) {

            // Перебираем все доступные устройства для захвата видеопотока:
            for (let i = 0; i < devices.length; i++) {
                var cameraId = devices[i].id;
                alert('i' + i + '~' + devices[i].id + ' p~ ' + devices.length + ' l ' + devices[i].label);
            }

            // Здесь начинается процесс сканирования:
            // Получаем идентификатор родительского контейнера сканера баркодов: 
            const html5QrCode = new Html5Qrcode("reader");

            // Обратный вызов при успешном сканировании:
            const qrCodeSuccessCallback = (decodedText, decodedResult) => {
                // Останавливаем использование камеры
                html5QrCode.stop().then((ignore) => {
                    // Сканирование QR-кода остановлено.
                    document.getElementById('text').innerText = `${decodedText}`; // .
                    document.getElementById('result').innerText = `${decodedResult.result.format.formatName}`; // .
                    document.querySelector('#reader').classList.add("d-none"); // .

                    interfaceReload(); // .

                    parseBarcodeOne(decodedText); // .
                }).catch((err) => {
                    // Остановка не удалась, смирись.
                });
            };

            // 
            const config = {
                fps: 10,
                qrbox: {
                    width: 250,
                    height: 250
                }
            };

            // 
            html5QrCode.start({ deviceId: { exact: cameraId } }, config, qrCodeSuccessCallback);
        }
    }).catch(err => {
        // handle err
    });

</script>

<!-- <script>
    // Handle on success condition with the decoded text or result.
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById('text').innerText = `${decodedText}`;
        document.getElementById('result').innerText = `${decodedResult.result.format.formatName}`;
        document.querySelector('#reader').classList.add("d-none");

        interfaceReload();

        // parseBarcodeOne('IIOTSENSE.RU/P?D10000034710111105871');
        parseBarcodeOne(decodedText);

        html5QrcodeScanner.stop();
        // document.location.href = "https://api.telegram.org/bot2100711838:AAE2qHOz6R68rHJZB93Xf_CDOyrfCiqCI7Q/sendMessage?chat_id=-1001752025790&text=result:" + `${decodedText}`;
    }

    // Handle on error condition, with error message
    function onScanError(errorMessage) {
        // alert('Ошибка сканирования!');
    }

    // Square QR Box, with size = 70% of the min edge.
    let qrboxFunction = function (viewfinderWidth, viewfinderHeight) {
        let minEdgeSizeThreshold = 300;
        let edgeSizePercentage = 0.8;
        let minEdgeSize = (viewfinderWidth > viewfinderHeight) ? viewfinderHeight : viewfinderWidth;
        let qrboxEdgeSize = Math.floor(minEdgeSize * edgeSizePercentage);
        if (qrboxEdgeSize < minEdgeSizeThreshold) {
            if (minEdgeSize < minEdgeSizeThreshold) {
                return {
                    width: minEdgeSize,
                    height: minEdgeSize
                };
            } else {
                return {
                    width: minEdgeSizeThreshold,
                    height: minEdgeSizeThreshold
                };
            }
        }
        return { width: qrboxEdgeSize, height: qrboxEdgeSize };
    }

    let config = {
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true
        },
        rememberLastUsedCamera: true,
        focusMode: "continuous",
        fps: 10,
        // qrbox: {
        //     width: 250,
        //     height: 250
        // },
        qrbox: qrboxFunction,
        showTorchButtonIfSupported: true,
        showZoomSliderIfSupported: true,
        defaultZoomValueIfSupported: 1,
        // supportedScanTypes: [
        //     Html5QrcodeScanType.SCAN_TYPE_CAMERA,
        //     Html5QrcodeScanType.SCAN_TYPE_FILE
        // ],
        // formatsToSupport: [
        //     Html5QrcodeSupportedFormats.QR_CODE,
        //     Html5QrcodeSupportedFormats.DATA_MATRIX
        // ],
    };

    let html5QrcodeScanner = new Html5QrcodeScanner("reader", config, /* verbose= */ false);
    html5QrcodeScanner.render(onScanSuccess, onScanError);

    // Костыли с переопределением CSS и Text для элементов интерфейса:
    let style33 = document.createElement('style');
    style33.innerHTML =
        `
        img {
            display:none;
        }
        `;
    document.head.appendChild(style33);


    // Привязка тега <a> для переключения выбора источника сканирования (камера или изображение):
    let anchorScanTypeChange = document.querySelector('#html5-qrcode-anchor-scan-type-change');
    let anchorScanTypeChangeFlag;
    anchorScanTypeChange.classList.remove("html5-qrcode-element");
    anchorScanTypeChange.classList.add("btn", "btn-success", "shadow", "mt-3", "text-decoration-none");
    anchorScanTypeChange.textContent = 'Сканировать из файла';

    // Идентификатор кнопки выбора файла:
    let btnFileSelection = document.querySelector('#html5-qrcode-button-file-selection');
    btnFileSelection.classList.remove("html5-qrcode-element");
    btnFileSelection.classList.add("btn", "btn-success", "shadow", "mt-3", "text-decoration-none");

    anchorScanTypeChange.addEventListener('click', function () {
        !anchorScanTypeChangeFlag ? anchorScanTypeChange.textContent = 'Сканировать камерой' : anchorScanTypeChange.textContent = 'Сканировать из файла';
        anchorScanTypeChangeFlag = !anchorScanTypeChangeFlag;
        btnFileSelection.textContent = 'Выбрать файл на устройстве';
    });



    // Дать разрешение на использование видеокамеры и начать захват видеопотока:
    let btnCameraPerm = document.querySelector('#html5-qrcode-button-camera-permission');
    btnCameraPerm.classList.remove("html5-qrcode-element");
    btnCameraPerm.classList.add("btn", "btn-success", "shadow");
    btnCameraPerm.textContent = 'Запустить сканирование';
    // btnCameraPerm.addEventListener('click', function () { });

    // let btnCameraStart = document.querySelector('#html5-qrcode-button-camera-start');
    // btnCameraStart.addEventListener('click', function () {
    //     btnCameraStop.classList.remove("html5-qrcode-element");
    //     btnCameraStop.classList.add("btn", "btn-success", "shadow");
    //     btnCameraStop.textContent = 'Стоп';
    // });

    // let btnCameraStop = document.querySelector('#html5-qrcode-button-camera-stop');
    // btnCameraStop.addEventListener('click', function () {
    //     btnCameraStart.classList.remove("html5-qrcode-element");
    //     btnCameraStart.classList.add("btn", "btn-success", "shadow");
    //     btnCameraStart.textContent = 'Старт';
    // });


    // let btnTorch = document.querySelector('#html5-qrcode-button-torch');
    // btnTorch.classList.remove("html5-qrcode-element");
    // btnTorch.classList.add("btn", "btn-success", "shadow");
    // btnTorch.textContent = 'Фонарик?';

    // let selectCamera = document.querySelector('#html5-qrcode-select-camera');
    // selectCamera.classList.remove("html5-qrcode-element");
    // selectCamera.classList.add("");
    // selectCamera.textContent = 'Выбрать камеру';



    // let NAME = document.getElementById('#html5-qrcode-input-range-zoom');
    // NAME.classList.remove("html5-qrcode-element");
    // NAME.classList.add("");
    // NAME.textContent = 'Масштабирование';

    // let readerHeaderMessage = document.getElementById('#reader__header_message');
    // if (readerHeaderMessage != null) {
    //     readerHeaderMessage.classList.remove("html5-qrcode-element");
    //     readerHeaderMessage.classList.add("");
    //     readerHeaderMessage.textContent = 'd';
    // }

    //
    // let btnTorchOn = document.getElementById('#html5-qrcode-button-torch-on');
    // if (btnTorchOn != null) {
    //     btnTorchOn.classList.remove("html5-qrcode-element");
    //     btnTorchOn.classList.add("");
    //     btnTorchOn.textContent = 'Включить фонарик';
    // }

    //
    // let btnTorchOff = document.querySelector('#html5-qrcode-button-torch-off');
    // if (btnTorchOff != null) {
    //     btnTorchOff.classList.remove("html5-qrcode-element");
    //     btnTorchOff.classList.add("");
    //     btnTorchOff.textContent = 'Выключить фонарик';
    // }
</script> -->

<script>
    const btnUp = {
        el: document.querySelector('.btn-up'),
        scrolling: false,
        show() {
            if (this.el.classList.contains('btn-up_hide') && !this.el.classList.contains('btn-up_hiding')) {
                this.el.classList.remove('btn-up_hide');
                this.el.classList.add('btn-up_hiding');
                window.setTimeout(() => {
                    this.el.classList.remove('btn-up_hiding');
                }, 300);
            }
        },
        hide() {
            if (!this.el.classList.contains('btn-up_hide') && !this.el.classList.contains('btn-up_hiding')) {
                this.el.classList.add('btn-up_hiding');
                window.setTimeout(() => {
                    this.el.classList.add('btn-up_hide');
                    this.el.classList.remove('btn-up_hiding');
                }, 300);
            }
        },
        addEventListener() {
            // при прокрутке окна (window)
            window.addEventListener('scroll', () => {
                const scrollY = window.scrollY || document.documentElement.scrollTop;
                if (this.scrolling && scrollY > 0) {
                    return;
                }
                this.scrolling = false;
                // если пользователь прокрутил страницу более чем на 200px
                if (scrollY > 400) {
                    // сделаем кнопку .btn-up видимой
                    this.show();
                } else {
                    // иначе скроем кнопку .btn-up
                    this.hide();
                }
            });
            // при нажатии на кнопку .btn-up
            document.querySelector('.btn-up').onclick = () => {
                this.scrolling = true;
                this.hide();
                // переместиться в верхнюю часть страницы
                window.scrollTo({
                    top: 0,
                    left: 0,
                    behavior: 'smooth'
                });
            }
        }
    }

    btnUp.addEventListener();
</script>

</html>
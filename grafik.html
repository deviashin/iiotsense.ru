<!DOCTYPE html>
<html>

<head>
    <title>Chart.js Example</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div>
        <label for="start-date">Start Date:</label>
        <input type="date" id="start-date">
        <label for="start-time">Start Time:</label>
        <input type="time" id="start-time">
        <label for="end-date">End Date:</label>
        <input type="date" id="end-date">
        <label for="end-time">End Time:</label>
        <input type="time" id="end-time">
        <button id="update-button">Update</button>
    </div>
    <div>
        <canvas id="myChart"></canvas>
    </div>

    <script>

        const jsonData = [
            {
                "label": 0xa4c138d24a7f0934,
                "linkquality": 247,
                "temperature_t1": -20.91,
                "temperature_t2": 145.54,
                "button_tamper": 1,
                "button_link": 0,
                "battery_voltage": 3.65,
                "date": "2023-04-04",
                "time": "07:50:16"
            },
            {
                "label": 0xa4c138d24a7f0934,
                "linkquality": 236,
                "temperature_t1": -21.44,
                "temperature_t2": 147.25,
                "button_tamper": 1,
                "button_link": 0,
                "battery_voltage": 3.64,
                "date": "2023-04-04",
                "time": "08:11:16"
            },
            {
                "label": 0xa4c138d24a7f0934,
                "linkquality": 236,
                "temperature_t1": -21.44,
                "temperature_t2": 147.25,
                "button_tamper": 0,
                "button_link": 0,
                "battery_voltage": 3.64,
                "date": "2023-04-05",
                "time": "08:05:16"
            },
            {
                "label": 0xa4c138d24a7f0934,
                "linkquality": 241,
                "temperature_t1": -19.76,
                "temperature_t2": 139.14,
                "button_tamper": 1,
                "button_link": 0,
                "battery_voltage": 3.65,
                "date": "2023-04-06",
                "time": "18:06:16"
            }
        ];

        const updateButton = document.getElementById('update-button');
        updateButton.addEventListener('click', function () {
            const startDate = document.getElementById('start-date').value;
            const startTime = document.getElementById('start-time').value;
            const endDate = document.getElementById('end-date').value;
            const endTime = document.getElementById('end-time').value;

            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(`${endDate}T${endTime}`);

            const filteredData = jsonData.filter((item) => {
                const itemDateTime = new Date(`${item.date}T${item.time}`);
                return itemDateTime >= startDateTime && itemDateTime <= endDateTime;
            });

            const chartData = convertJsonToChartData(filteredData);

            myChart.data = chartData;
            myChart.update();
        });


        function convertJsonToChartData(jsonData) {
            // Создаем объект с начальными значениями
            const data = {
                labels: [],
                datasets: []
            };

            // Проходим по каждому элементу массива JSON данных
            jsonData.forEach((item, index) => {
                // Добавляем метку для оси X, соединяя дату и время
                const label = item.date + ' ' + item.time;
                data.labels.push(label);

                // Проходим по каждому свойству элемента
                Object.keys(item).forEach((key) => {
                    // Пропускаем свойства "label", "date" и "time"
                    if (key === 'label' ||
                        key === 'date' ||
                        key === 'time' ||
                        key === 'button_tamper' ||
                        key === 'button_link'
                    ) {
                        return;
                    }

                    // Создаем новый набор данных для каждого свойства
                    let dataset = data.datasets.find((d) => d.label === key);
                    if (!dataset) {
                        dataset = {
                            label: key,
                            data: [],
                            fill: false
                        };
                        data.datasets.push(dataset);
                    }

                    // Добавляем значение свойства в набор данных
                    dataset.data.push(item[key]);
                });
            });

            return data;
        }

        const datatas = convertJsonToChartData(jsonData);

        const config = {
            type: 'line',
            data: datatas,
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'Chart.js Example'
                    }
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero: true
                        }
                    }]
                }
            }
        };
        var myChart = new Chart(
            document.getElementById('myChart'),
            config
        );
    </script>
</body>

</html>